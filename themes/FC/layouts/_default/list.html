{{- define "main" }}

{{ if not hugo.IsProduction }}
  {{- partial "debug.html" . -}}
{{ end }}

{{- if .IsHome | and .Title }}
  {{- partial "hero.html" . }}
{{- end }}

{{- if not .IsHome | and .Title }}
<header class="list-header">
  <h1 class="list-title">
    {{/* see: https://gohugo.io/variables/taxonomy/#taxonomy-terms-page-variables */}}
    <span class="title">
      {{- if eq .Kind "term" -}}{{- .Data.Singular }}: {{ end -}}
    {{ .Title | .RenderString -}}</span>
  </h1>
  {{- if .Description }}
  <div class="list-description">
    <span class="description">{{ .Description | .RenderString }}</span>
  </div>
  {{- end }}
  {{- partial "cover.html" . }}
</header>
{{- end }}

<section class="articles-list">
{{/* get the latest pages from the current section, and fill in the missing translated pages from the first site (currently English) */}}
{{- $pages := where (.RegularPages | lang.Merge .Sites.Default.RegularPages) "Section" .Section }}

{{- if .IsHome }}
  {{/* get the 6 latest regular pages in the main section (defined in hugo.yaml or number of pages, currently "news"), except the ones with the "hero" parameters in front matter */}}
  {{- $pages = where (where (site.RegularPages | lang.Merge .Sites.Default.RegularPages) "Section" "in" site.Params.mainSections) "Params.hero" "!=" true | first 6 }}
{{- end }}

{{- if eq .Kind "term" -}}
  {{- $pages = .RegularPages -}}
{{- end -}}

{{/* related issue: https://github.com/gohugoio/hugo/issues/9003 */}}
{{ $paginator := "" }}
{{ if (.Param "paginate") }}
  {{- $paginator = .Paginate $pages (.Param "paginate") }}
{{ else }}
  {{- $paginator = .Paginate $pages }}
{{ end }}

{{- $term := .Data.Term }}
{{- range $index, $page := $paginator.Pages }}

<article class="article-entry">
  <a href="{{ .Permalink }}" alt="ARTICLE" aria-label="Link to {{ .Title | plainify }} article" title="Link to {{ .Title | plainify }} article">
    {{- partial "cover.html" . }}
  <div class="entry-date">
    {{- if not .Date.IsZero -}}
      <time datetime="{{ .Date }}">{{ .Date | time.Format ":date_full" }}</time>
    {{- end }}
  </div>
  <header class="entry-header">
    <h2 class="entry-title">
      <span>{{- .Title | .RenderString }}</span>
      {{- if .Draft }}<sup><span class="entry-isdraft">&nbsp;&nbsp;[Draft]</span></sup>{{- end }}
      {{- if .Weight }}<sup><span class="entry-isdraft">&nbsp;&nbsp;[Pinned]</span></sup>{{- end }}
    </h2>
    {{- if (ne (.Param "hideSummary") true) }}
    <div class="entry-description">
      {{ if .Description }}
        <p>{{ .Description | .RenderString }}</p>
      {{ else }}
        <p>{{ .Summary | .RenderString }}{{ if .Truncated }}...{{ end }}</p>
      {{ end }}
    </div>
    {{- end }}
  </header>
  </a>
</article>

{{- end }}
</section>

{{/* Get the content for the Homepage. */}}
{{- if .IsHome -}}
  {{- with (index (where (.RegularPages | lang.Merge .Sites.Default.RegularPages) "Type" "homepage") 0) -}}
    {{- partial "content.html" . -}}
  {{- end -}}
{{- end -}}

{{- if gt $paginator.TotalPages 1 }}
<footer class="list-footer">
  <nav class="list-pagination">
    {{- if $paginator.HasPrev }}
    <a class="prev" href="{{ $paginator.Prev.URL }}" alt="PREVIOUS" aria-label="Link to previous articles" title="Link to previous articles">« {{ i18n "prev_page" }}</a>
    {{- end }}
    {{- if $paginator.HasNext }}
    <a class="next" href="{{ $paginator.Next.URL }}" alt="NEXT" aria-label="Link to next articles" title="Link to next articles">{{ i18n "next_page" }} »</a>
    {{- end }}
  </nav>
</footer>
{{- end }}

{{- end }}{{- /* end main */ -}}
